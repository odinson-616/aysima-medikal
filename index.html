<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AYSİMA MEDİKAL | Ürünler</title>
  <style>
    :root { --bordo: #7b1e2b; --gri: #f4f4f4; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--gri); display: flex; flex-direction: column; min-height: 100vh; }
    
    header { background-color: var(--bordo); color: white; padding: 15px 30px; display: flex; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    header img { height: 45px; margin-right: 15px; background: white; border-radius: 4px; padding: 2px; }

    .layout { display: flex; flex: 1; max-width: 1200px; margin: 0 auto; width: 100%; padding: 20px; gap: 20px; }
    
    /* Yan Menü */
    aside { width: 250px; background: white; padding: 20px; border-radius: 8px; height: fit-content; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    aside h3 { color: var(--bordo); margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .category-list { list-style: none; padding: 0; }
    .category-list li { padding: 10px; cursor: pointer; border-radius: 4px; transition: 0.2s; }
    .category-list li:hover { background: #fff5f6; color: var(--bordo); }
    .category-list li.active { background: var(--bordo); color: white; }

    /* Ürün Alanı */
    main { flex: 1; }
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .product-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee; }
    .product-name { font-size: 1.1rem; font-weight: bold; color: var(--bordo); margin-bottom: 10px; display: block; }
    .variant-box { background: #fafafa; padding: 8px; border-radius: 4px; margin-top: 5px; font-size: 0.85rem; border-left: 3px solid #ddd; }
    .price { font-weight: bold; color: #333; float: right; }
    .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; text-transform: uppercase; }
    .status-ok { background: #e6f4ea; color: #1e7e34; }
    .status-none { background: #fce8e6; color: #d93025; }
  </style>
</head>
<body>

  <header>
    <img src="logo.png" alt="Logo">
    <div style="font-size: 1.3rem; font-weight: bold;">AYSİMA MEDİKAL</div>
  </header>

  <div class="layout">
    <aside>
      <h3>Kategoriler</h3>
      <ul class="category-list" id="category-menu">
        <li class="active" onclick="loadProducts(null)">Tüm Ürünler</li>
        </ul>
    </aside>

    <main>
      <h2 id="category-title">Tüm Ürünler</h2>
      <div class="product-grid" id="product-list">Yükleniyor...</div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://eqpioawtdwkaeuxpfspt.supabase.co";
    const supabaseKey = "sb_publishable_j1qHO04E6qvGJxoQksdHlA_p89plyCA";
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // 1. Kategorileri Yükle
    async function loadCategories() {
      const { data } = await _supabase.from("categories").select("*");
      const menu = document.getElementById("category-menu");
      data?.forEach(cat => {
        const li = document.createElement("li");
        li.textContent = cat.name;
        li.onclick = () => {
          document.querySelectorAll('.category-list li').forEach(el => el.classList.remove('active'));
          li.classList.add('active');
          loadProducts(cat.id, cat.name);
        };
        menu.appendChild(li);
      });
    }

    // 2. Ürünleri Yükle (Kategoriye göre filtreli)
    async function loadProducts(categoryId = null, categoryName = "Tüm Ürünler") {
      document.getElementById("category-title").textContent = categoryName;
      let query = _supabase.from("products").select(`*, product_variants(*)`).eq("is_active", true);
      
      if (categoryId) {
        query = query.eq("category_id", categoryId);
      }

      const { data: products, error } = await query;

      const container = document.getElementById("product-list");
      container.innerHTML = "";

      products?.forEach(product => {
        let variantsHtml = "";
        // Varyantları fiyata göre sırala
        const sortedVariants = product.product_variants.sort((a, b) => a.price - b.price);
        
        sortedVariants.forEach(v => {
          const isAvailable = v.stock > 0;
          variantsHtml += `
            <div class="variant-box">
              <span>${v.variant_value}</span>
              ${isAvailable 
                ? `<span class="price">${v.price} TL</span>` 
                : `<span class="price" style="color:red">TÜKENDİ</span>`}
            </div>`;
        });

        container.innerHTML += `
          <div class="product-card">
            <span class="product-name">${product.name}</span>
            <small style="color:#666">${product.brand || ''}</small>
            <div style="margin-top:10px">${variantsHtml}</div>
          </div>`;
      });
    }

    loadCategories();
    loadProducts();
  </script>
</body>
</html>
