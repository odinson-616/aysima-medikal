<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AYSÄ°MA MEDÄ°KAL | GÃ¼venilir SaÄŸlÄ±k Marketiniz</title>

  <style>
    :root { --bordo:#7b1e2b; --bg:#f4f6f9; --border:#e1e4e8; }
    body{margin:0;font-family:Segoe UI,sans-serif;background:var(--bg);color:#333}

    .top-bar{background:#000;color:#fff;text-align:center;padding:7px;font-size:12px}
    header{background:#fff;padding:15px 5%;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    .logo{font-size:26px;font-weight:900;color:var(--bordo);text-decoration:none}

    .search-box{flex:1;max-width:500px;margin:0 25px;display:flex}
    .search-box input{width:100%;padding:12px;border:1px solid var(--border)}
    .search-box button{background:var(--bordo);color:#fff;border:none;padding:0 20px;cursor:pointer}

    .cart-trigger{cursor:pointer;position:relative}
    .cart-badge{position:absolute;top:-8px;right:-10px;background:var(--bordo);color:#fff;border-radius:50%;padding:2px 7px;font-size:11px}

    nav{background:#fff;border-bottom:1px solid var(--border);display:flex;overflow-x:auto}
    .nav-link{padding:15px 20px;font-size:13px;font-weight:700;color:#555;text-decoration:none}

    .content{max-width:1400px;margin:25px auto;padding:0 20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px}

    .card{background:#fff;border:1px solid var(--border);padding:15px;display:flex;flex-direction:column}
    .v-btn{border:1px solid #ddd;background:#fff;padding:5px 10px;font-size:12px;margin:3px;cursor:pointer}
    .v-btn.selected{border-color:var(--bordo);color:var(--bordo)}
    .v-btn:disabled{opacity:.4;cursor:not-allowed}

    .price-area{margin-top:auto;display:flex;justify-content:space-between;align-items:center;padding-top:15px}
    .price-val{font-size:18px;font-weight:800;color:var(--bordo)}
    .buy-btn{background:var(--bordo);color:#fff;border:none;padding:10px 15px;cursor:pointer}
    .buy-btn:disabled{background:#ccc}

    #cart-sidebar{position:fixed;right:-360px;top:0;width:340px;height:100%;background:#fff;transition:.3s;z-index:20;padding:20px;display:flex;flex-direction:column}
    #cart-sidebar.open{right:0}
    #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;z-index:19}
    #overlay.active{display:block}
  </style>
</head>

<body>

<div class="top-bar">STOKTAN AYNI GÃœN TESLÄ°MAT</div>

<header>
  <a class="logo">AYSÄ°MA</a>
  <div class="search-box">
    <input placeholder="ÃœrÃ¼n ara..." onkeyup="search(this.value)">
    <button>ARA</button>
  </div>
  <div class="cart-trigger" onclick="toggleCart(true)">
    ðŸ›’ <span class="cart-badge" id="cart-count">0</span>
  </div>
</header>

<nav id="navbar">
  <a href="#" class="nav-link" onclick="location.reload()">TÃœM ÃœRÃœNLER</a>
</nav>

<div class="content">
  <h2 id="page-name">TÃ¼m ÃœrÃ¼nler</h2>
  <div class="grid" id="product-grid"></div>
</div>

<div id="overlay" onclick="toggleCart(false)"></div>

<div id="cart-sidebar">
  <h3>Sepet</h3>
  <div id="cart-items" style="flex:1"></div>
  <b>Toplam: <span id="cart-total">0.00</span> TL</b>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl="https://eqpioawtdwkaeuxpfspt.supabase.co";
const supabaseKey="sb_publishable_j1qHO04E6qvGJxoQksdHlA_p89plyCA";
const db=window.supabase.createClient(supabaseUrl,supabaseKey);

let masterData=[];
let cart=JSON.parse(localStorage.getItem("aysima_cart"))||[];

async function bootstrap(){
  const {data:cats}=await db.from("categories").select("*").is("parent_id",null);
  cats?.forEach(c=>{
    const a=document.createElement("a");
    a.className="nav-link";a.textContent=c.name;
    a.onclick=e=>{e.preventDefault();fetchProducts(c.id,c.name)};
    navbar.appendChild(a);
  });
  fetchProducts();
  updateCartUI();
}

async function fetchProducts(cid=null,name="TÃ¼m ÃœrÃ¼nler"){
  page-name.textContent=name;
  let q=db.from("products").select("*,product_variants(*)").eq("is_active",true);
  if(cid) q=q.eq("category_id",cid);
  const {data}=await q;
  masterData=data||[];
  render(masterData);
}

function render(list){
  product-grid.innerHTML="";
  list.forEach(p=>{
    const vars=p.product_variants.filter(v=>v.is_active);
    if(!vars.length) return;
    const d=vars[0];
    const out=d.stock<=0;

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div style="height:140px;background:#f7f7f7;margin-bottom:10px"></div>
      <b>${p.name}</b>
      <div>${vars.map(v=>`
        <button class="v-btn ${v.id===d.id?'selected':''}" ${v.stock<=0?'disabled':''}
        onclick="selectVar(this,'${v.id}','${v.price}','${v.variant_value}',${v.stock})">${v.variant_value}</button>`).join("")}</div>
      <div class="price-area">
        <span class="price-val">${d.price} TL</span>
        <button class="buy-btn" ${out?'disabled':''}
          data-vid="${d.id}" data-price="${d.price}" data-name="${d.variant_value}" data-stock="${d.stock}"
          onclick="addToCart('${p.id}','${p.name}',this)">
          ${out?'TÃœKENDÄ°':'EKLE'}
        </button>
      </div>`;
    product-grid.appendChild(card);
  });
}

window.selectVar=(b,id,price,name,stock)=>{
  const c=b.closest(".card");
  c.querySelectorAll(".v-btn").forEach(x=>x.classList.remove("selected"));
  b.classList.add("selected");
  c.querySelector(".price-val").textContent=price+" TL";
  const btn=c.querySelector(".buy-btn");
  btn.dataset.vid=id;btn.dataset.price=price;btn.dataset.name=name;btn.dataset.stock=stock;
  btn.disabled=stock<=0;btn.textContent=stock<=0?"TÃœKENDÄ°":"EKLE";
}

function addToCart(pid,pname,btn){
  if(btn.dataset.stock<=0) return;
  const v=cart.find(i=>i.pid===pid&&i.vid===btn.dataset.vid);
  v?v.qty++:cart.push({pid,pname,vid:btn.dataset.vid,vname:btn.dataset.name,price:+btn.dataset.price,qty:1});
  localStorage.setItem("aysima_cart",JSON.stringify(cart));
  updateCartUI();toggleCart(true);
}

function updateCartUI(){
  cart-items.innerHTML="";
  let t=0,c=0;
  cart.forEach((i,idx)=>{
    t+=i.price*i.qty;c+=i.qty;
    cart-items.innerHTML+=`${i.pname} (${i.vname}) x${i.qty}<br>`;
  });
  cart-total.textContent=t.toFixed(2);
  cart-count.textContent=c;
}

function toggleCart(s){
  cart-sidebar.classList.toggle("open",s);
  overlay.classList.toggle("active",s);
}

function search(t){
  t=t.toLowerCase();
  render(masterData.filter(p=>p.name.toLowerCase().includes(t)));
}

bootstrap();
</script>
</body>
</html>
